---
title: "BUnwarpJ image registration with DEMs"
author: "Jason Goetz"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{BUnwarpJ image registration with DEMs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE}
embed_png <- function(path, dpi = NULL) {
  meta <- attr(png::readPNG(path, native = TRUE, info = TRUE), "info")
  if (!is.null(dpi)) meta$dpi <- rep(dpi, 2)
  knitr::asis_output(paste0(
    "<img src='", path, "'",
    " width=", round(meta$dim[1] / (meta$dpi[1] / 96)),
    " height=", round(meta$dim[2] / (meta$dpi[2] / 96)),
    " />"
  ))
}
knitr::opts_chunk$set(comment = "#>", collapse = TRUE)
```



This vigenette is a short tutorial showing how to apply [BUnwarpJ plugin](https://imagej.net/BUnwarpJ) image registration to digital elevation models (DEMs).

### Install Fiji
Install [Fiji](https://fiji.sc/)

### Open hillshade models
File > Open
May have trouble running with GEOTIFF –have to convert to PNG. – e.g with [IrfanView](https://www.irfanview.net/) (save with no compression) 
(Remember order e.g. first 2012 than 2017)
First, rock_glacier_hillshade_2012_50cm.tif
Then, rock_glacier_hillshade_2017_50cm.tif

```{r, echo = FALSE}
embed_png("Fiji-toolbar.png")
```

```{r, echo = FALSE}
embed_png("open_hillshade_2012.png")
```

```{r, echo = FALSE}
embed_png("open_hillshade_2017.png")
```  

### Open bunwarpJ plugin and map landmarks
Plugins > Registration > bUnwarpJ

Map landmarks on 2012 and adjust in 2017 (stable and active areas)

```{r, echo = FALSE}
embed_png("bunwarpj_toolbar.png")
```

```{r, echo = FALSE}
embed_png("landmark_all_hillshade_2012.png")
```

```{r, echo = FALSE}
embed_png("landmark_all_hillshade_2017.png")
```

### Save landmarks
Save landmarks bunwarpJ I/O Menu > Save Landmarks As…

```{r, echo = FALSE}
embed_png("bunwarpj_io_menu.png")
```

Name the file to remember the direction of mapping (i.e. 2012 to 2017; Landmarks_source2012_to_target2017.txt).

Note: When loading landmarks – make sure that source image is 2012 and the target 2017, otherwise the landmarks will not be positioned correctly.

### Run registration
Can use the following settings (Note: mapping/loading landmarks will automatically use them for registration).

```{r, echo = FALSE}
embed_png("bunwarpj_settings.png")
```

Save transformation task will pop up when registration is complete. 

```{r, echo = FALSE}
embed_png("convert_direct_to_raw_select_elastic.png")
```

### Convert transformation to RAW
This transformation file can be opened in R using the bunwarpj(). Re-name to include RAW just for file management. 
In the I/O Menu select Convert Transformation to RAW
1.	First select the transformation file
2.	Write the filename – can be confusing because it says OPEN instead of convert/save

```{r, echo = FALSE}
embed_png("convert_direct_to_raw_output_filename.png")
```

